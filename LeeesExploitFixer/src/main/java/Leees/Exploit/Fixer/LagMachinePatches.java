package Leees.Exploit.Fixer;

        import net.minecraft.server.v1_12_R1.MinecraftServer;
        import org.bukkit.*;
        import org.bukkit.block.Block;
        import org.bukkit.entity.*;
        import org.bukkit.event.EventHandler;
        import org.bukkit.event.Listener;
        import org.bukkit.event.block.*;
        import org.bukkit.event.entity.EntityPortalEvent;
        import org.bukkit.event.entity.ExplosionPrimeEvent;
        import org.bukkit.event.player.PlayerInteractEvent;
        import org.bukkit.scheduler.BukkitRunnable;

public class LagMachinePatches implements Listener {

    //public static File lmFile;
    @SuppressWarnings({ "unchecked", "rawtypes" })
    //public static ArrayList<String> possibleLm = new ArrayList();


    public static void sendOpMessgge(String message) {
        for (Player online : Bukkit.getOnlinePlayers()) {
            if (online.isOp()) {
                online.sendMessage(ChatColor.translateAlternateColorCodes('&', message));

            }
        }
    }
    public static Player getNearbyPlayers(int i, Location loc) {
        Player plrs = null;
        for (Player nearby : loc.getNearbyPlayers(i)) {
            plrs = nearby;

        }
        return plrs;
    }

    @EventHandler
    public void onEntityPortal(EntityPortalEvent event) {
        Entity entity = event.getEntity();
        if (!(event.getEntity() instanceof Player)) {
            if (entity.getPassenger() instanceof Player) {
                Player player = (Player)event.getEntity().getPassenger();
                if (entity instanceof Item ||
                        entity instanceof Donkey ||
                        entity instanceof Horse ||
                        entity instanceof Pig ||
                        entity instanceof Mule ||
                        entity instanceof Llama) {
                    player.getVehicle().eject();
                    event.setCancelled(true);
                    entity.remove();
                }
            }
            event.getEntity().remove();
            event.setCancelled(true);
        }
        if (entity.getPassenger() instanceof Player) {
            Player player = (Player)event.getEntity().getPassenger();
            if (entity instanceof Item ||
                    entity instanceof Donkey ||
                    entity instanceof Horse ||
                    entity instanceof Pig ||
                    entity instanceof Mule ||
                    entity instanceof Llama) {
                player.getVehicle().eject();
                event.setCancelled(true);
                entity.remove();
            }
        }
    }

    @EventHandler
    public void onRedstoneTick(BlockRedstoneEvent event) {
        try {
            if (MinecraftServer.getServer().recentTps[0] <= 15
                    && !(event.getBlock().getType() == Material.TRAPPED_CHEST)) {
                Block block = event.getBlock();
                String fagMachine = "Deleted a taco machine at " + block.getLocation().getBlockX() + " "
                        + block.getLocation().getBlockY() + " " + block.getLocation().getBlockZ() + " in world "
                        + block.getLocation().getWorld().getName() + "";
                event.setNewCurrent(0);
                event.getBlock().setType(Material.AIR);
                this.sendOpMessgge(
                        "&6[LeeesExploitFixer] Removed a lag machine at &r&1" + block.getLocation().getBlockX() + " "
                                + block.getLocation().getBlockY() + " " + block.getLocation().getBlockZ()
                                + "&r&6 owned by &r&1 " + this.getNearbyPlayers(50, block.getLocation()).getName());
                //event.getBlock().getLocation().getWorld().strikeLightning(event.getBlock().getLocation());
                System.out.println(ChatColor.translateAlternateColorCodes('&', "&a" + fagMachine));
                for (Player nearby : block.getLocation().getNearbyPlayers(20)) {
                    if (!nearby.isOp()) {
                        nearby.chat(">>>>I have a lag machine `tp to me admins");
                    }
                }
                for (Entity ents : block.getChunk().getEntities()) {
                    if (!(ents instanceof Player)) {
                        ents.remove();
                        System.out.println(ChatColor.GREEN + "Removed " + block.getChunk().getEntities().length
                                + " from a laggy chunk");
                        this.sendOpMessgge("&6[LeeesExploitFixer] Removed &r&1" + block.getChunk().getEntities().length
                                + "&r&6 from &r&1" + ents.getChunk().getX() + " " + ents.getChunk().getZ());
                    }
                }
            }
        } catch (StackOverflowError | NullPointerException e) {

        }
    }

    @EventHandler
    public void ondispence(BlockDispenseEvent event) {
        if (Utils.getTps() <= 16) {
            event.setCancelled(true);
        }
    }

    @EventHandler
    public void onExploision(ExplosionPrimeEvent event) {

        if (!event.getEntity().getType().equals(EntityType.ENDER_CRYSTAL) && MinecraftServer.getServer().recentTps[0] <= 15) {

            int Blockx = event.getEntity().getLocation().getBlockX();
            int Blocky = event.getEntity().getLocation().getBlockY();
            int Blockz = event.getEntity().getLocation().getBlockZ();

            for (Player nearby : event.getEntity().getLocation().getNearbyPlayers(20)) {
                nearby.sendMessage(ChatColor.translateAlternateColorCodes('&', "&1-------------------"));
                nearby.sendMessage(ChatColor.translateAlternateColorCodes('&', "&6Tnt is disabled"));
                nearby.sendMessage(ChatColor.translateAlternateColorCodes('&', "&6due to low tps :("));
                nearby.sendMessage(ChatColor.translateAlternateColorCodes('&', "&1-------------------"));

                System.out.println(ChatColor.translateAlternateColorCodes('&', "&6Tnt removed at &cX " + Blockx + " Y " + Blocky + " Z " + Blockz));
                event.getEntity().remove();
                event.setCancelled(true);

            }
        }
    }
    public static VilationUtils vm = new VilationUtils();

    @EventHandler
    public void onPull(PlayerInteractEvent event) {
        if (event.getAction() == Action.RIGHT_CLICK_BLOCK) {
            if (event.getClickedBlock().getType() == Material.LEVER) {
                Player player = event.getPlayer();
                vm.addVls(player, 3);
                new BukkitRunnable() {
                    @Override
                    public void run() {
                        if (vm.vlMapContainsPlayer(player)) {
                            vm.removeVl(player, vm.getVls(player) - 1);
                        }
                    }
                }.runTaskLater(Main.getPlugin(), 5);
                System.out.println(vm.getVls(player));
                if (vm.getVls(player) >= 5) {
                    event.setCancelled(true);
                    Utils.kickPlayer(player, Utils.getPrefix() + "&6AntiFaggotExploit by 254n_m");
                    vm.resetVls(player);

                }
            }
        }

    }
}